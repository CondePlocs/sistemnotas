// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum para el estado del usuario
enum EstadoUsuario {
  activo
  inactivo
  suspendido
}

// Modelo Usuario - Core del login
model Usuario {
  id             Int           @id @default(autoincrement())
  email          String        @unique
  password_hash  String
  dni            String?       @unique // DNI común para todos los usuarios
  nombres        String?
  apellidos      String?
  telefono       String?
  estado         EstadoUsuario @default(activo)
  creado_en      DateTime      @default(now())
  actualizado_en DateTime      @updatedAt

  // Relaciones
  roles           UsuarioRol[] @relation("UsuarioRoles")
  creados         UsuarioRol[] @relation("CreadoPor")
  salonesCreados  Salon[]      @relation("SalonCreador") // ← Salones creados por este usuario

  // Relaciones de permisos
  permisosOtorgados     PermisosAdministrativo[] @relation("PermisosOtorgados")
  permisosActualizados  PermisosAdministrativo[] @relation("PermisosActualizados")

  // Relaciones de alumnos
  alumnosCreados        Alumno[] @relation("AlumnoCreador")

  // Relaciones de apoderado-alumno
  relacionesApoderadoAlumno ApoderadoAlumno[] @relation("RelacionCreador")

  // Relaciones de cursos y competencias
  cursosCreados       Curso[]       @relation("CursoCreador")
  competenciasCreadas Competencia[] @relation("CompetenciaCreador")
  
  // Relaciones de asignación alumno-salón
  asignacionesAlumnoSalon AlumnoSalon[] @relation("AlumnoSalonAsignador")

  @@map("usuario")
}

// Modelo Rol - Catálogo de roles del sistema
model Rol {
  id     Int    @id @default(autoincrement())
  nombre String @unique

  // Relaciones
  usuarios_rol UsuarioRol[]

  @@map("rol")
}

// Modelo UsuarioRol - Vincula un usuario con un rol y un colegio (scope)
model UsuarioRol {
  id         Int       @id @default(autoincrement())
  usuario_id Int
  rol_id     Int
  colegio_id Int? // nullable para roles globales como OWNER
  hecho_por  Int? // ID del usuario que creó este registro (auditoría)
  hecho_en   DateTime? // Fecha/hora de creación (auditoría)

  // Relaciones
  usuario   Usuario  @relation("UsuarioRoles", fields: [usuario_id], references: [id], onDelete: Cascade)
  rol       Rol      @relation(fields: [rol_id], references: [id], onDelete: Cascade)
  colegio   Colegio? @relation(fields: [colegio_id], references: [id], onDelete: Cascade)
  creadoPor Usuario? @relation("CreadoPor", fields: [hecho_por], references: [id])

  // Relación con perfiles específicos
  director       Director?
  profesor       Profesor?
  apoderado      Apoderado?
  administrativo Administrativo?

  @@unique([usuario_id, rol_id, colegio_id])
  @@index([usuario_id])
  @@index([colegio_id])
  @@map("usuario_rol")
}

// Modelo DRE - Dirección Regional de Educación
model DRE {
  id     Int     @id @default(autoincrement())
  nombre String  @unique
  codigo String? @unique

  // Relaciones
  ugeles UGEL[]

  @@map("dre")
}

// Modelo UGEL - Unidad de Gestión Educativa Local
model UGEL {
  id     Int     @id @default(autoincrement())
  dreId  Int
  nombre String
  codigo String? @unique

  // Relaciones
  dre      DRE       @relation(fields: [dreId], references: [id])
  colegios Colegio[]

  @@map("ugel")
}

// Modelo Colegio - Instituciones educativas
model Colegio {
  id            Int      @id @default(autoincrement())
  ugelId        Int? // vinculado a UGEL
  nombre        String
  codigoModular String?  @unique
  distrito      String?
  direccion     String?
  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  // Relaciones
  ugel              UGEL?          @relation(fields: [ugelId], references: [id])
  usuariosRol       UsuarioRol[]
  nivelesPermitidos ColegioNivel[] // ← Niveles educativos autorizados
  salones           Salon[]        // ← Salones del colegio
  alumnos           Alumno[]       // ← Alumnos del colegio

  @@map("colegio")
}

// Enum para niveles educativos
enum NivelEducativo {
  INICIAL
  PRIMARIA
  SECUNDARIA
}

// Modelo ColegioNivel - Niveles autorizados por colegio
model ColegioNivel {
  id                Int            @id @default(autoincrement())
  colegioId         Int
  nivel             NivelEducativo
  activo            Boolean        @default(true)
  puedeCrearSalones Boolean        @default(true)
  creadoEn          DateTime       @default(now())
  actualizadoEn     DateTime       @updatedAt

  // Relaciones
  colegio Colegio @relation(fields: [colegioId], references: [id], onDelete: Cascade)

  @@unique([colegioId, nivel])
  @@map("colegio_nivel")
}

// Modelo Salon - Salones/Aulas por colegio
model Salon {
  id            Int            @id @default(autoincrement())
  colegioId     Int
  nivel         NivelEducativo
  grado         String         // "1° Primaria", "3 años", "2° Secundaria"
  seccion       String         // "A", "Los Leones", "Rojo", "Único"
  activo        Boolean        @default(true)
  creadoPor     Int            // ID del director que creó el salón (auditoría)
  creadoEn      DateTime       @default(now())
  actualizadoEn DateTime       @updatedAt

  // Relaciones
  colegio     Colegio @relation(fields: [colegioId], references: [id], onDelete: Cascade)
  creadorUser Usuario @relation("SalonCreador", fields: [creadoPor], references: [id])
  
  // Relación con alumnos (muchos a muchos)
  alumnos     AlumnoSalon[]

  // Evitar duplicados: Un colegio no puede tener dos salones iguales
  @@unique([colegioId, nivel, grado, seccion])
  @@index([colegioId])
  @@index([creadoPor])
  @@map("salon")
}

// Modelo Profesor - Perfil específico para profesores
model Profesor {
  id           Int        @id @default(autoincrement())
  usuarioRol   UsuarioRol @relation(fields: [usuarioRolId], references: [id], onDelete: Cascade)
  usuarioRolId Int        @unique

  // Datos personales adicionales
  fechaNacimiento DateTime?
  sexo            String?
  estadoCivil     String?
  nacionalidad    String?

  // Contacto
  direccion String?

  // Formación académica
  gradoAcademico    String?
  especialidad      String?
  institucionEgreso String?

  // Datos laborales
  fechaIngreso       DateTime?
  condicionLaboral   String? // nombrado, contratado

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  actualizadoPor Int? // ID del usuario que hizo la última actualización

  @@map("profesor")
}

// Modelo Apoderado - Perfil específico para padres/tutores
model Apoderado {
  id           Int        @id @default(autoincrement())
  usuarioRol   UsuarioRol @relation(fields: [usuarioRolId], references: [id], onDelete: Cascade)
  usuarioRolId Int        @unique

  // Datos personales adicionales
  fechaNacimiento DateTime?
  sexo            String?
  estadoCivil     String?
  nacionalidad    String?

  // Contacto
  direccion String?

  // Datos laborales (opcional, útil para contacto en emergencias)
  ocupacion       String?
  centroTrabajo   String?
  telefonoTrabajo String?

  // Relación con alumnos (muchos a muchos)
  alumnos ApoderadoAlumno[]

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  actualizadoPor Int? // ID del usuario que hizo la última actualización

  @@map("apoderado")
}

// Modelo Administrativo - Perfil específico para personal administrativo
model Administrativo {
  id           Int        @id @default(autoincrement())
  usuarioRol   UsuarioRol @relation(fields: [usuarioRolId], references: [id], onDelete: Cascade)
  usuarioRolId Int        @unique

  // Datos personales adicionales
  fechaNacimiento DateTime?
  sexo            String?
  estadoCivil     String?
  nacionalidad    String?

  // Contacto
  direccion String?

  // Datos laborales
  cargo            String // secretaria, coordinador, auxiliar, etc.
  fechaIngreso     DateTime?
  condicionLaboral String? // nombrado, contratado

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt
  actualizadoPor Int? // ID del usuario que hizo la última actualización

  // Relación con permisos
  permisos PermisosAdministrativo?

  @@map("administrativo")
}

// Modelo Director - Perfil específico para directores (SIN duplicación de colegio)
model Director {
  id           Int        @id @default(autoincrement())
  usuarioRol   UsuarioRol @relation(fields: [usuarioRolId], references: [id], onDelete: Cascade)
  usuarioRolId Int        @unique

  // Datos personales específicos del director
  fechaNacimiento DateTime?
  sexo            String?
  estadoCivil     String?
  nacionalidad    String?

  // Contacto
  direccion String?

  // Formación académica
  gradoAcademico    String?
  carrera           String?
  especializacion   String?
  institucionEgreso String?

  // Datos laborales
  fechaInicio DateTime?

  creadoEn      DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  @@map("director")
}

// Modelo PermisosAdministrativo - Sistema de permisos para personal administrativo
model PermisosAdministrativo {
  id                              Int      @id @default(autoincrement())
  administrativoId                Int      @unique
  
  // Permisos específicos
  puedeRegistrarProfesores        Boolean  @default(false)
  puedeRegistrarApoderados        Boolean  @default(false)
  puedeRegistrarAdministrativos   Boolean  @default(false)
  puedeRegistrarAlumnos           Boolean  @default(false)
  puedeGestionarSalones           Boolean  @default(false)
  
  // Auditoría - Quién otorgó los permisos
  otorgadoPor                     Int?
  otorgadoEn                      DateTime @default(now())
  
  // Auditoría - Última actualización
  actualizadoPor                  Int?
  actualizadoEn                   DateTime @updatedAt
  
  // Relaciones
  administrativo                  Administrativo @relation(fields: [administrativoId], references: [id], onDelete: Cascade)
  usuarioOtorgador                Usuario? @relation("PermisosOtorgados", fields: [otorgadoPor], references: [id])
  usuarioActualizador             Usuario? @relation("PermisosActualizados", fields: [actualizadoPor], references: [id])
  
  @@map("permisos_administrativo")
}

// Enum para el sexo del alumno
enum SexoAlumno {
  masculino
  femenino
}

// Modelo Alumno - Estudiantes del colegio
model Alumno {
  id                Int        @id @default(autoincrement())
  colegioId         Int        // Scope por colegio
  
  // Identificación personal
  dni               String?    @unique
  nombres           String
  apellidos         String
  fechaNacimiento   DateTime?
  sexo              SexoAlumno?
  nacionalidad      String?    @default("Peruana")
  
  // Contacto y residencia
  direccion         String?
  distrito          String?
  numeroContacto    String?
  
  // Información académica básica
  activo            Boolean    @default(true)
  
  // Auditoría
  creadoPor         Int        // Usuario que registró al alumno
  creadoEn          DateTime   @default(now())
  actualizadoEn     DateTime   @updatedAt
  
  // Relaciones
  colegio           Colegio    @relation(fields: [colegioId], references: [id], onDelete: Cascade)
  creadorUser       Usuario    @relation("AlumnoCreador", fields: [creadoPor], references: [id])
  
  // Relación con apoderados (muchos a muchos)
  apoderados        ApoderadoAlumno[]
  
  // Relación con salones (muchos a muchos)
  salones           AlumnoSalon[]
  
  // Índices para optimización
  @@index([colegioId])
  @@index([dni])
  @@index([activo])
  
  @@map("alumno")
}

// Modelo ApoderadoAlumno - Tabla intermedia para relación muchos a muchos
model ApoderadoAlumno {
  id           Int       @id @default(autoincrement())
  apoderadoId  Int       // FK al apoderado
  alumnoId     Int       // FK al alumno
  
  // Información específica de la relación
  parentesco   String    // padre, madre, tío, hermano, tutor legal, abuelo, etc.
  esPrincipal  Boolean   @default(false) // Apoderado principal del alumno
  activo       Boolean   @default(true)  // Para soft delete de relaciones
  
  // Auditoría completa
  creadoPor    Int       // Usuario que creó la relación (director/administrativo)
  creadoEn     DateTime  @default(now())
  actualizadoEn DateTime @updatedAt
  actualizadoPor Int?    // Usuario que hizo la última actualización
  
  // Relaciones
  apoderado    Apoderado @relation(fields: [apoderadoId], references: [id], onDelete: Cascade)
  alumno       Alumno    @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  creador      Usuario   @relation("RelacionCreador", fields: [creadoPor], references: [id])
  
  // Índices únicos y de optimización
  @@unique([apoderadoId, alumnoId]) // Un apoderado no puede tener relación duplicada con el mismo alumno
  @@index([apoderadoId])
  @@index([alumnoId])
  @@index([activo])
  @@index([esPrincipal])
  
  @@map("apoderado_alumno")
}

// ========================================
// SISTEMA DE CURSOS Y COMPETENCIAS
// ========================================

// Modelo Curso - Cursos creados por el Owner (Matemática, Comunicación, etc.)
model Curso {
  id          Int            @id @default(autoincrement())
  nombre      String         // "Matemática", "Comunicación", "Personal Social"
  descripcion String?        // Descripción opcional del curso
  nivel       NivelEducativo // INICIAL, PRIMARIA, SECUNDARIA
  color       String?        // Color para UI (ej: "#3B82F6")
  activo      Boolean        @default(true)
  creadoPor   Int            // Owner que creó el curso
  creadoEn    DateTime       @default(now())
  actualizadoEn DateTime     @updatedAt

  // Relaciones
  competencias Competencia[]
  creador      Usuario       @relation("CursoCreador", fields: [creadoPor], references: [id])

  // Constraints e índices
  @@unique([nombre, nivel]) // No duplicar "Matemática - PRIMARIA"
  @@index([nivel])
  @@index([activo])
  @@index([creadoPor])
  @@index([nivel, activo]) // Búsquedas optimizadas por nivel activo
  
  @@map("curso")
}

// Modelo Competencia - Competencias de cada curso
model Competencia {
  id          Int      @id @default(autoincrement())
  cursoId     Int
  nombre      String   // "Domina números y operaciones", "Desarrolla lógica matemática"
  orden       Int      // Para ordenar competencias (1, 2, 3, ...)
  activo      Boolean  @default(true)
  creadoPor   Int      // Owner que creó la competencia
  creadoEn    DateTime @default(now())
  actualizadoEn DateTime @updatedAt

  // Relaciones
  curso   Curso   @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  creador Usuario @relation("CompetenciaCreador", fields: [creadoPor], references: [id])

  // Constraints e índices
  @@unique([cursoId, orden]) // No duplicar orden en mismo curso
  @@index([cursoId])
  @@index([activo])
  @@index([creadoPor])
  @@index([cursoId, orden, activo]) // Ordenamiento eficiente
  
  @@map("competencia")
}

// ========================================
// SISTEMA DE ASIGNACIÓN ALUMNO-SALÓN
// ========================================

// Modelo AlumnoSalon - Relación muchos a muchos entre Alumno y Salón
model AlumnoSalon {
  id               Int       @id @default(autoincrement())
  alumnoId         Int
  salonId          Int
  fechaAsignacion  DateTime  @default(now())
  fechaRetiro      DateTime? // Cuando el alumno sale del salón
  activo           Boolean   @default(true)
  asignadoPor      Int       // Usuario que hizo la asignación
  creadoEn         DateTime  @default(now())
  actualizadoEn    DateTime  @updatedAt

  // Relaciones
  alumno      Alumno  @relation(fields: [alumnoId], references: [id], onDelete: Cascade)
  salon       Salon   @relation(fields: [salonId], references: [id], onDelete: Cascade)
  asignador   Usuario @relation("AlumnoSalonAsignador", fields: [asignadoPor], references: [id])

  // Constraints e índices
  @@unique([alumnoId, salonId, activo]) // Un alumno activo por salón específico
  @@index([alumnoId])
  @@index([salonId])
  @@index([activo])
  @@index([fechaAsignacion])
  @@index([salonId, activo]) // Consultas de alumnos por salón
  @@index([alumnoId, activo]) // Historial de salones por alumno
  
  @@map("alumno_salon")
}
